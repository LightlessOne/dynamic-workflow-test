name: _Execute_Image_Module

on:
  workflow_call:
    inputs:
      stage_id:
        required: true
        type: string
      job_id:
        required: true
        type: string
      module_image:
        required: true
        type: string
      module_command:
        required: true
        type: string
      input:
        required: false
        type: string
      output:
        required: false
        type: string
      when:
        required: false
        type: string

env:
  GITHUB_MODULES_OPS_URL: https://github.com/LightlessOne/Quber-CLI/releases/latest/download/github_modules_ops.pyz
  #GITHUB_MODULES_OPS_URL: https://github.com/LightlessOne/Quber-CLI/releases/download/v0.0.1/github_modules_ops.pyz

jobs:
  execute-module-command:
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.module_image }}
    env:
      input: ${{ inputs.input }}
      output: ${{ inputs.output }}
      when: ${{ inputs.when }}
      CI_JOB_NAME: ${{ inputs.job_id }}
      CI_JOB_STAGE: ${{ inputs.stage_id }}
    steps:
      - name: Download files
        id: download-files
        uses: actions/download-artifact@v4
        with:
          path: rt/stored_data
          merge-multiple: true

      - name: Prepare Data
        id: prepare-data
        run: |
          wget -O /usr/quber/github_modules_ops.pyz $GITHUB_MODULES_OPS_URL
          unzip -q /usr/quber/github_modules_ops.pyz -d /usr/quber/github_modules_ops
          python /usr/quber/github_modules_ops prepare-data

      - name: Execute Module Command
        id: execute-module-command
        run: python /usr/quber/module_cli ${{ inputs.module_command }} --context_path rt/job_data/context.yaml

      - name: Store Data
        id: store-data
        if: always()
        run: |
          python /usr/quber/github_modules_ops store-data
          mkdir -p rt/stored_data/${{inputs.stage_id}}/${{inputs.job_id}}/

      - name: Store Github IDs
        id: store-github-data
        if: always()
        shell: python
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURRENT_JOB_NAME: ${{ inputs.job_id }} / execute-module-command
        run: |
          import json, os
          from urllib.request import urlopen, Request
          url = f"{os.getenv('GITHUB_API_URL')}/repos/{os.getenv('GITHUB_REPOSITORY')}/actions/runs/{os.getenv('GITHUB_RUN_ID')}/jobs"
          httprequest = Request(url, headers={"Authorization": f"Bearer {os.getenv('GH_TOKEN')}"})
          with urlopen(httprequest) as response:
              jobs = json.loads(response.read().decode())
          current_job = [job for job in jobs["jobs"] if job["name"] == os.getenv('CURRENT_JOB_NAME')]
          if not current_job:
              raise Exception("Could not find current job data in github response!")
          current_job = current_job[0]
          with open('rt/stored_data/${{inputs.stage_id}}/${{inputs.job_id}}/stats.yaml', 'w') as fs:
              fs.write(f"run_id: {current_job['run_id']}\njob_id: {current_job['id']}")

      - name: Upload files
        id: upload-files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.job_id }}
          path: rt/stored_data
